name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  package:
    name: Package ${{ matrix.distro }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fullaxx/fbpanel_builder:${{ matrix.distro }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: noble
            pkg_gen: DEB
            pkg_ext: deb
            libdir: lib
          - distro: jammy
            pkg_gen: DEB
            pkg_ext: deb
            libdir: lib
          - distro: focal
            pkg_gen: DEB
            pkg_ext: deb
            libdir: lib
          - distro: trixie
            pkg_gen: DEB
            pkg_ext: deb
            libdir: lib
          - distro: bookworm
            pkg_gen: DEB
            pkg_ext: deb
            libdir: lib
          - distro: bullseye
            pkg_gen: DEB
            pkg_ext: deb
            libdir: lib
          - distro: fedora43
            pkg_gen: RPM
            pkg_ext: rpm
            libdir: lib64
          - distro: fedora42
            pkg_gen: RPM
            pkg_ext: rpm
            libdir: lib64
          - distro: fedora41
            pkg_gen: RPM
            pkg_ext: rpm
            libdir: lib64
          - distro: fedora40
            pkg_gen: RPM
            pkg_ext: rpm
            libdir: lib64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -B build -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_INSTALL_LIBDIR=${{ matrix.libdir }}

      - name: Build
        run: make -C build -j$(nproc)

      - name: Package
        run: cd build && cpack -G ${{ matrix.pkg_gen }}

      - name: Rename with distro suffix
        run: |
          cd build
          PKG=$(ls *.${{ matrix.pkg_ext }} | head -1)
          BASE="${PKG%.${{ matrix.pkg_ext }}}"
          mv "$PKG" "${BASE}_${{ matrix.distro }}.${{ matrix.pkg_ext }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.distro }}
          path: build/*.${{ matrix.pkg_ext }}

  release:
    name: Publish GitHub Release
    needs: package
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          pattern: pkg-*
          merge-multiple: true

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.deb
            *.rpm
          generate_release_notes: true
